#pragma once
#include "Mesh.hpp"
#include <array>
#include <vector>
using namespace std;

using Vert2 = array<int, 2>;
using Tri = array<int, 3>;
using Matrix = vector<vector<int>>;

inline const vector<vector<Vert2>> vertLookup = {
    {}, // 0000
    {{0,0},{1,0},{0,1}}, // 0001
    {{2,0},{1,0},{2,1}}, // 0010
    {{0,0},{0,1},{2,0},{2,1}}, // 0011
    {{2,2},{2,1},{1,2}}, // 0100
    {{0,1},{1,0},{1,2},{2,1},{0,0},{2,2}}, // 0101
    {{1,0},{1,2},{2,0},{2,2}}, // 0110
    {{0,0},{0,1},{2,0},{2,2},{1,2}}, // 0111
    {{0,2},{0,1},{1,2}}, // 1000
    {{0,0},{1,0},{0,2},{1,2}}, // 1001
    {{1,2},{0,1},{2,1},{1,0},{2,0},{0,2}}, // 1010
    {{2,1},{0,0},{2,0},{0,2},{1,2}}, // 1011
    {{0,2},{2,2},{2,1},{0,1}}, // 1100
    {{0,2},{2,2},{0,0},{1,0},{2,1}}, // 1101
    {{0,1},{0,2},{1,0},{2,0},{2,2}}, // 1110
    {{0,0},{0,2},{2,0},{2,2}} // 1111
};

const vector<vector<Tri>> topFaceLookup = {
    {}, // 0000
    {{0,1,2}}, // 0001
    {{0,2,1}}, // 0010
    {{0,3,1},{0,2,3}}, // 0011
    {{0,2,1}}, // 0100
    {{2,0,1},{1,3,2},{0,4,1},{3,5,2}}, // 0101
    {{1,0,3},{3,0,2}}, // 0110
    {{1,2,4},{1,0,2},{3,4,2}}, // 0111
    {{0,1,2}}, // 1000
    {{0,1,3},{0,3,2}}, // 1001
    {{3,0,1},{2,0,3},{3,4,2},{0,5,1}}, // 1010
    {{1,0,4},{0,1,2},{4,3,1}}, // 1011
    {{0,2,1},{2,0,3}}, // 1100
    {{0,4,1},{3,0,2},{4,0,3}}, // 1101
    {{2,4,0},{4,2,3},{1,0,4}}, // 1110
    {{1,0,3},{3,0,2}} // 1111
};

const vector<vector<Tri>> bottomFaceLookup = {
    {}, // 0000
    {{0,2,1}}, // 0001
    {{0,1,2}}, // 0010
    {{0,1,3},{0,3,2}}, // 0011
    {{0,1,2}}, // 0100
    {{2,1,0},{1,2,3},{0,1,4},{3,2,5}}, // 0101
    {{1,3,0},{3,2,0}}, // 0110
    {{1,4,2},{1,2,0},{3,2,4}}, // 0111
    {{0,2,1}}, // 1000
    {{0,3,1},{0,2,3}}, // 1001
    {{3,1,0},{2,3,0},{3,2,4},{0,1,5}}, // 1010
    {{1,4,0},{0,2,1},{4,1,3}}, // 1011
    {{0,1,2},{2,3,0}}, // 1100
    {{0,1,4},{3,2,0},{4,3,0}}, // 1101
    {{2,0,4},{4,3,2},{1,4,0}}, // 1110
    {{1,3,0},{3,2,0}} // 1111
};

const vector<vector<vector<Tri>>> sideFaceLookup = {
    {}, // 0000
    {{{0,1,0},{1,0,1},{1,0,0}}, {{1,0,1},{0,1,0},{0,1,1}}}, // 0001
    {{{1,0,0},{1,0,1},{2,1,0}}, {{1,0,1},{2,1,1},{2,1,0}}}, // 0010
    {{{0,1,0},{0,1,1},{2,1,1}}, {{2,1,1},{2,1,0},{0,1,0}}}, // 0011
    {{{2,1,1},{1,2,1},{2,1,0}}, {{2,1,0},{1,2,1},{1,2,0}}}, // 0100
    {{{1,0,0},{2,1,0},{1,0,1}}, {{2,1,0},{2,1,1},{1,0,1}},
    {{0,1,1},{1,2,1},{0,1,0}}, {{0,1,0},{1,2,1},{1,2,0}}}, // 0101
    {{{1,0,0},{1,0,1},{1,2,0}}, {{1,0,1},{1,2,1},{1,2,0}}}, // 0110
    {{{0,1,1},{1,2,1},{0,1,0}}, {{0,1,0},{1,2,1},{1,2,0}}}, // 0111
    {{{0,1,1},{0,1,0},{1,2,1}}, {{0,1,0},{1,2,0},{1,2,1}}}, // 1000
    {{{1,0,0},{1,2,1},{1,0,1}}, {{1,0,0},{1,2,0},{1,2,1}}}, // 1001
    {{{2,1,1},{1,2,0},{1,2,1}}, {{2,1,0},{1,2,0},{2,1,1}},
    {{1,0,0},{1,0,1},{0,1,0}}, {{1,0,1},{0,1,1},{0,1,0}}}, // 1010
    {{{2,1,1},{1,2,0},{1,2,1}}, {{2,1,0},{1,2,0},{2,1,1}}}, // 1011
    {{{2,1,0},{2,1,1},{0,1,1}}, {{0,1,1},{0,1,0},{2,1,0}}}, // 1100
    {{{1,0,0},{2,1,0},{1,0,1}}, {{2,1,0},{2,1,1},{1,0,1}}}, // 1101
    {{{1,0,0},{1,0,1},{0,1,0}}, {{1,0,1},{0,1,1},{0,1,0}}}, // 1110
    {} // 1111
};

class MarchingSquare{
    public:
    MarchingSquare(Matrix matrix, int w, int h);
    void marchSquares();
    void exportMesh(string &filename);

    private:
    int width;
    int height;
    Matrix m;
    Mesh mesh;

    vector<vector<vector<int>>> vertRef;

    int indexFromMatrix(int startX, int startY);
    void vertsFromMatrix();

    void addVertsFromSquare(int startX, int startY, float size);
    void marchSquare(int startX, int startY);


};

